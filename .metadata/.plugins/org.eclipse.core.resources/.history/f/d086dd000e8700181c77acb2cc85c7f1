<%@ page contentType="text/html;charset=UTF-8"%>
<%@ include file="/WEB-INF/views/include/taglib.jsp"%>
<c:set var="basepath" value="/admin/core/modules/edu/train/common/edu-sent-email"></c:set>
<html>

<head>
	<title></title>
	<meta name="decorator" content="default" />
	<script type="text/javascript" src="${ctxStatic}/common/common.js"></script>
	<script type="text/javascript" src="${ctxStatic}/lib/layer/layer.js"></script>
	<style type="text/css">
		body{
		overflow:auto;
	  }
		.email_btn{
			width: 100px!important;
		    height: 40px!important;
		    line-height: 40px!important;
		    border-radius: 6px;
		    border: none;
		    color: #fff;
		    font-size: 18px;
		    outline: none;
		}
		.select_all{
			background-color: #3daae9;
		}
		.select_none{
			background-color: #ff994d;
		}
		.email_send{
			background-color: #56823e;
		}
		.email_div {
		    height: 337px;
		    width: 580px;
		    margin: 10px;
		}
		.email_main {
		    padding: 0px 20px;
		    font-size: 16px;
		    font-weight: bold;
		}
		input#email_subject {
		    width: 410px;
		    height: 30px;
		    line-height: 30px;
		    font-size: 17px
		}
		textarea#email_content {
		    width: 410px;
		    height: 225px;
		    vertical-align: top;
		    font-size: 17px
		}
		.anniu {
		    text-align: center;
		}
		.anniu input{
			margin-left:10px;
		}
		.sure{
			background-color: #56823e;
		}
		.cancel{
			background-color:#FE8D7D; 
		}
		.queren{
			width:100%;
			height: calc(100% - 20px);
		}
		.tb_div{
			height:300px;
			overflow: auto;
		}
		table.tb {
		    width: 90%;
		    padding-left: auto;
		    margin: auto;
		    margin-top: 20px;
		    font-size: 16px;
		    border: solid 1px #aaa;
		    text-align: center;
		}
		table.tb tbody{
			width:100%;
		}
		table.tb tr {
		    border-bottom: solid 1px #aaa;
		    height:35px;
		}
		.person{
			height:57px;
			text-align: center;
		}
		.person input{
			margin-left:20px;
			margin-top:10px;
		}
		.email_btn2{
		    min-width:100px;
		    height: 40px!important;
		    line-height: 40px!important;
		    border-radius: 6px;
		    border: none;
		    color: #fff;
		    font-size: 18px;
		    outline: none;
		}
		table.tb td {
		    padding: 0px 20px 0px 20px;
		}
	</style>
	<script type="text/javascript">
		//当页面重新加载的时候,清除sessionStorage中存储的值
		window.onload = function(){
			sessionStorage.removeItem("checkedArray");    
		}
	
	
		//下面的做法是为了翻页之后已经选择了的收件人会保留下来
		var checkedArray = JSON.parse(sessionStorage.getItem("checkedArray"));
		if(checkedArray==null || checkedArray.length==0){
			checkedArray = [];
		}
		$(document).ready(function() {
			// 表格排序
			tableSort({
				callBack : page
			});
			
			
			//循环遍历当前页的数据,与sessionStorage中存储的email进行比较,如果有的话就要将复选框的checked设置为true
			$(".selected_email").each(function(){
				var email = $(this).attr("data-id");
				for(var i=0;i<checkedArray.length;i++){
					var temp = checkedArray[i];
					if(email == temp){
						$(this).attr("checked","checked");
					}
				}
			});
			
			
			//点击复选框,选择要发送邮件的用户
			$(".selected_email").click(function(){
				var email = $(this).attr("data-id");
				if(isBlank(email)){
					layer.alert('该邮箱为空,请选择其他邮箱');
					return false;
				}
				var checked = $(this).attr("checked");
				if(checked=='checked'){  //勾选
					add2Array(checkedArray,email);
				}else{  //取消勾选
					removeFromArray(checkedArray,email);
				}
			});
			
			
			//点击"全选"
			$(".select_all").click(function(){
				$(".selected_email").each(function(){
					$(this).attr("checked","checked");
					var email = $(this).attr("data-id");
					add2Array(checkedArray,email);
				});
				console.log(checkedArray.length);
			});
			
			
			//点击"全不选"
			$(".select_none").click(function(){
				checkedArray = [];
				$(".selected_email").each(function(){
					$(this).attr("checked",false);
				});
			});
			
			
			var clicked = false;
			//点击"发送邮件"
			$(".email_send").click(function(){
				if(checkedArray.length==0){
					layer.msg('请选择要发送的用户',{
						icon:2,
						time:2000
					});
					return;
				}
				if(!clicked){
					clicked = true;
					var url = '/admin/core/modules/yyzj/user/yyzj-user/findUserByEmail.do';
					$.ajax({
						url:url,
						type:'POST',
						dataType:'json',
						traditional: true,
						data:{
							emails:checkedArray
						},
						success:function(result){
							var userList = result.data.userList;
							var html = '<div class="queren">'
								 + '	<div class="tb_div">'
								 + '	<table class="tb">'
								 + '		</tbody>'
								 + '			<tr>'
								 + '				<td>姓名</td>'
								 + '				<td>用户名</td>'
								 + '				<td>邮箱</td>'
								 + '			</tr>';
							for(var i=0;i<userList.length;i++){
								var temp = userList[i];
								html +='		<tr>'
									 + '			<td>'+temp.name+'</td>'
									 + '			<td>'+temp.username+'</td>'
									 + '			<td>'+temp.email+'</td>'
									 + '		</tr>';
							}
								html +='	</tbody>'
									 + '</table>'
									 +'</div>'
									 + '<div class="person"><input type="button" name="q_person" class="email_btn2 q_person email_send" value="编辑邮件"/><input type="button" name="c_person" class="email_btn2 c_person select_none" value="修改" /></div>'
									 + '</div>';
							
							layer.open({
								type:1,
								title:'确认收件人',
								area:['600px','400px'], //宽高
								content:html,
								cancel:function(){ 
									clicked = false;
								}
							});
						},
						error:function(){
							
						}
					});
				}
			});
			
			
			//点击"编辑邮件"
			$("body").on("click",".q_person",function(){
				layer.closeAll();
				clicked = false;
				var html = '<div class="email_div">'
					 + '	<div class="email_main">'
					 + '		邮件主题：<input type="text" name="subject" id="email_subject" placeholder="请输入邮件主题" /><br/>'
					 + '		邮件内容：<textarea name="content" id="email_content" placeholder="请输入邮件内容"></textarea>'
					 + '	</div>'
					 + '	<div class="anniu">'
					 + '		<input type="button" class="email_btn sure" value="发送"/>'
					 + '		<input type="button" class="email_btn cancel" value="取消"/>'
					 + '	</div>'
					 + '</div>';
				layer.open({
					type:1,
					title:'填写邮件信息',
					area:['600px','400px'], //宽高
					content:html
				});
			});
			
			//点击"修改"
			$("body").on("click",".c_person",function(){
				layer.closeAll();
				clicked = false;
			});
			
			//点击"发送"
			$("body").on("click",".sure",function(){
				if(!validate()){
					return false;
				}else{
					var receiveAddress = checkedArray;
					var subject = $("#email_subject").val();
					var content = $("#email_content").val();
					//请求后台发送邮件
					var url = '${basepath}/sendEmail${suffix}';
					$.ajax({
						url:url,
						traditional: true,   //加上这一个参数才能传递数组到后台
						type:'POST',
						dataType:'json',
						data:{
							receiveAddress:checkedArray,
							ccAddress:[],
							bccAddress:[],
							subject:subject,
							content:content
						},
						success:function(result){
							layer.closeAll();
							$("#email_subject").val('');
							$("#email_content").val('');
							layer.msg('发送成功',{
								icon:1,
								time:2000,
							});
						},
						error:function(){
							layer.msg('发送失败',{
								icon:2,
								time:2000
							});
						}
					});
				}
				
			});
			
			
			//点击"取消"
			$("body").on("click",".cancel",function(){
				layer.closeAll();
				$("#email_subject").val('');
				$("#email_content").val('');
			});
			
		});
	
		function page(n, s) {
			//下面的做法是为了翻页之后已经选择了的收集人会保留下来
			sessionStorage.setItem("checkedArray",JSON.stringify(checkedArray));
			$("#pageNo").val(n);
			$("#pageSize").val(s);
			$("#searchForm").attr("action", "${basepath}/list${suffix}").submit();
			return false;
		}
		
		//验证邮件的主题和内容非空
		function validate(){
			if(isBlank($("#email_subject").val())){
				layer.alert("邮件主题必填")
				$("#email_subject").focus();
				return false;
			}
			if(isBlank($("#email_content").val())){
				layer.alert("邮件内容必填")
				$("#email_content").focus();
				return false;
			}
			return true;
		}
		
	</script>
</head>

<body>
	<ul class="nav nav-tabs">
		<li class="active"><a href="${basepath}/list${suffix}">用户列表</a></li>
	</ul>
	<form:form id="searchForm" modelAttribute="bean" action="${basepath}/list${suffix}" method="post" class="breadcrumb form-search">
		<input id="pageNo" name="pageNo" type="hidden" value="${page.pageNo}" />
		<input id="pageSize" name="pageSize" type="hidden" value="10" />
		<input id="orderBy" name="orderBy" type="hidden" value="${page.orderBy}" />
		<div>
			<label>关键字：</label>
				<input type="text" class="input-small" name="word" value="${word}" placeholder="请输入关键字" />
			<input id="btnSubmit" class="btn btn-primary" type="submit" value="查询" />
		</div>
	</form:form>

	<tags:message content="${message}" />

	<table id="contentTable" class="table table-striped table-bordered table-condensed">
		<thead>
			<tr>
				<th></th>
				<th>序号</th>
				<th>姓名</th>
				<th>身份</th>
				<th>电话</th>
				<th>邮箱</th>
				<th>账号状态</th>
		</thead>
		<tbody>
			<c:forEach items="${page.list}" var="item" varStatus="status">
				<tr>
					<c:if test="${!empty item.accountIdentity}">
						<c:if test="${item.accountIdentity=='SCHOOL'}"><c:set value="${item.school.email}" var="email"></c:set></c:if>
						<c:if test="${item.accountIdentity=='TEACHER'}"><c:set value="${item.teacher.email}" var="email"></c:set></c:if>
						<c:if test="${item.accountIdentity=='STUDENT'}"><c:set value="${item.student.email}" var="email"></c:set></c:if>
						<c:if test="${item.accountIdentity=='GUARDIAN'}"><c:set value="${item.guardian.email}" var="email"></c:set></c:if>
					</c:if>
					<td><input type="checkbox" name="selected_email" class="selected_email" data-id="${email }"></td>
					<td>${status.count}</td>
					<td>
						<c:if test="${!empty item.accountIdentity}">
							<c:if test="${item.accountIdentity=='SCHOOL'}">${item.school.name }</c:if>
							<c:if test="${item.accountIdentity=='TEACHER'}">${item.teacher.name }</c:if>
							<c:if test="${item.accountIdentity=='STUDENT'}">${item.student.name }</c:if>
							<c:if test="${item.accountIdentity=='GUARDIAN'}">${item.guardian.useName }</c:if>
						</c:if>
					</td>
					<td>
						<c:if test="${!empty item.accountIdentity}">${item.accountIdentity.name }</c:if>
					</td>
					<td>${item.mobile}</td>
					<td>
						<c:if test="${!empty item.accountIdentity}">
							<c:if test="${item.accountIdentity=='SCHOOL'}">${item.school.email }</c:if>
							<c:if test="${item.accountIdentity=='TEACHER'}">${item.teacher.email }</c:if>
							<c:if test="${item.accountIdentity=='STUDENT'}">${item.student.email }</c:if>
							<c:if test="${item.accountIdentity=='GUARDIAN'}">${item.guardian.email }</c:if>
						</c:if>
					</td>
					<td>
						<c:choose>
							<c:when test="${!item.enableFlag}"><span style="color:red;">已禁用</span></c:when>
							<c:when test="${item.enableFlag}"><span style="color:blue;">已启用</span></c:when>
							<c:otherwise></c:otherwise>
						</c:choose>
					</td>
				</tr>
			</c:forEach>
		</tbody>
	</table>
	<input type="button" name="select_all" class="email_btn select_all" value="全选" />
	<input type="button" name="select_none" class="email_btn select_none" value="全不选" />
	<input type="button" name="email_send" class="email_btn email_send" value="发送邮件" />
	<div class="pagination">${page}</div>
</body>

</html>